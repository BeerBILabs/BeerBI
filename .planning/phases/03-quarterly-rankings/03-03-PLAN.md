---
phase: 03-quarterly-rankings
plan: 03
type: execute
wave: 3
depends_on: ["03-02"]
files_modified:
  - frontend/project/components/RankChangeIndicator.tsx
  - frontend/project/components/QuarterlyLeaderboard.tsx
  - frontend/project/app/rankings/all/page.tsx
  - frontend/project/app/rankings/[year]/[quarter]/page.tsx
  - frontend/project/app/layout.tsx
  - frontend/project/components/UsersPage.tsx
autonomous: false

must_haves:
  truths:
    - "Quarterly leaderboard shows top givers with beer counts for that quarter"
    - "Quarterly leaderboard shows top recipients with beer counts for that quarter"
    - "Rank change indicators show movement compared to previous quarter"
    - "New users (not in previous quarter) show NEW badge"
    - "All-time leaderboard shows lifetime totals"
    - "Header contains link to Rankings page"
    - "Main leaderboard page has button to explore rankings"
  artifacts:
    - path: "frontend/project/components/RankChangeIndicator.tsx"
      provides: "Rank movement indicator (arrows, NEW badge)"
      exports: ["RankChangeIndicator"]
      contains: "ChevronsUp"
    - path: "frontend/project/components/QuarterlyLeaderboard.tsx"
      provides: "Leaderboard component with rank changes"
      exports: ["QuarterlyLeaderboard"]
      contains: "RankChangeIndicator"
    - path: "frontend/project/app/rankings/[year]/[quarter]/page.tsx"
      provides: "Quarterly page with actual leaderboard"
      contains: "QuarterlyLeaderboard"
    - path: "frontend/project/app/rankings/all/page.tsx"
      provides: "All-time page with actual leaderboard"
      contains: "QuarterlyLeaderboard"
    - path: "frontend/project/app/layout.tsx"
      provides: "Header with Rankings link"
      contains: "/rankings"
  key_links:
    - from: "frontend/project/components/QuarterlyLeaderboard.tsx"
      to: "frontend/project/components/RankChangeIndicator.tsx"
      via: "import RankChangeIndicator"
      pattern: "<RankChangeIndicator"
    - from: "frontend/project/app/rankings/[year]/[quarter]/page.tsx"
      to: "frontend/project/components/QuarterlyLeaderboard.tsx"
      via: "import QuarterlyLeaderboard"
      pattern: "<QuarterlyLeaderboard"
    - from: "frontend/project/components/QuarterlyLeaderboard.tsx"
      to: "/api/proxy/"
      via: "fetch API"
      pattern: "fetch.*api/proxy"
---

<objective>
Complete the quarterly rankings feature: leaderboard display with rank change indicators, all-time view, and entry points from header and main page.

Purpose: Fulfill all display requirements (QRANK-02, QRANK-03) and enable user discovery of the feature (QRANK-01 entry points).

Output: Fully functional quarterly and all-time leaderboards with visual rank movement indicators and navigation entry points.
</objective>

<execution_context>
@/home/tdolfen/.claude/get-shit-done/workflows/execute-plan.md
@/home/tdolfen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-quarterly-rankings/03-CONTEXT.md
@.planning/phases/03-quarterly-rankings/03-RESEARCH.md
@.planning/phases/03-quarterly-rankings/03-01-SUMMARY.md
@.planning/phases/03-quarterly-rankings/03-02-SUMMARY.md
@frontend/project/lib/quarters.ts
@frontend/project/components/UsersList.tsx
@frontend/project/components/UsersPage.tsx
@frontend/project/app/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create RankChangeIndicator and QuarterlyLeaderboard components</name>
  <files>
    frontend/project/components/RankChangeIndicator.tsx
    frontend/project/components/QuarterlyLeaderboard.tsx
  </files>
  <action>
Create two client components for leaderboard display:

**RankChangeIndicator.tsx:**
- Props: `currentRank: number`, `previousRank: number | null` (null = new to leaderboard)
- Import icons from lucide-react: ChevronUp, ChevronDown, ChevronsUp, ChevronsDown, Minus
- If previousRank is null, return "NEW" badge:
  ```tsx
  <span
    className="text-xs font-medium px-1.5 py-0.5 rounded"
    style={{
      backgroundColor: 'hsl(var(--accent))',
      color: 'hsl(var(--accent-foreground))'
    }}
  >
    NEW
  </span>
  ```
- Calculate change = previousRank - currentRank (positive = moved up in rank)
- If change === 0, return Minus icon with muted color
- If |change| >= 3, use double arrows (ChevronsUp/ChevronsDown)
- If |change| < 3, use single arrows (ChevronUp/ChevronDown)
- Up arrows: green `hsl(142 76% 36%)`, Down arrows: red `hsl(0 72% 51%)`
- Add aria-label describing the movement: "Up 2 places", "Down 5 places", "No change", "New this quarter"

**QuarterlyLeaderboard.tsx:**
- Props: `year: number | null`, `quarter: number | null`, `showRankChange?: boolean` (default true for quarters, false for all-time)
- "use client" component
- Fetch users from /api/proxy/givers and /api/proxy/recipients (same as UsersPage)
- Calculate date range using getQuarterDates from lib/quarters (if year/quarter provided)
- For all-time (year/quarter null), don't pass date params
- Fetch stats for current period (same pattern as UsersList)
- If showRankChange is true, ALSO fetch previous quarter data:
  - Use getPreviousQuarter to get prev year/quarter
  - Fetch stats for previous quarter in parallel
  - Build rank maps: currentRanks[userId] = rank, previousRanks[userId] = rank or null
- Render two-column grid (same as UsersPage):
  ```tsx
  <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
    <LeaderboardColumn title="Givers" users={sortedGivers} previousRanks={prevGiverRanks} showRankChange={showRankChange} />
    <LeaderboardColumn title="Recipients" users={sortedRecipients} previousRanks={prevRecipientRanks} showRankChange={showRankChange} />
  </div>
  ```
- LeaderboardColumn (internal component): Similar to UsersList but includes RankChangeIndicator next to each user's name
- Show loading skeleton while fetching (3-4 placeholder rows per column)
- Show error state with retry button on fetch failure
- Show empty state: "No beers recorded for this quarter" with beer emoji
- Match UsersList styling exactly: card background, padding, hover states, avatar handling
  </action>
  <verify>
Run: `cd /home/tdolfen/Projects/github.com/BeerBILabs/frontend/project && npx tsc --noEmit components/RankChangeIndicator.tsx components/QuarterlyLeaderboard.tsx`
TypeScript compiles without errors.
  </verify>
  <done>RankChangeIndicator shows arrows/badges correctly. QuarterlyLeaderboard fetches and displays ranked users with optional rank change indicators.</done>
</task>

<task type="auto">
  <name>Task 2: Wire leaderboards into rankings pages and add entry points</name>
  <files>
    frontend/project/app/rankings/all/page.tsx
    frontend/project/app/rankings/[year]/[quarter]/page.tsx
    frontend/project/app/layout.tsx
    frontend/project/components/UsersPage.tsx
  </files>
  <action>
Update pages to use actual leaderboards and add navigation entry points:

**rankings/all/page.tsx:**
- Import QuarterlyLeaderboard
- Remove placeholder text
- Render: `<QuarterlyLeaderboard year={null} quarter={null} showRankChange={false} />`
- Keep metadata export

**rankings/[year]/[quarter]/page.tsx:**
- Import QuarterlyLeaderboard
- Remove placeholder text
- After validating params, render: `<QuarterlyLeaderboard year={yearNum} quarter={quarterNum} showRankChange={true} />`
- Keep generateMetadata export

**layout.tsx (header):**
- Add "Rankings" link in header next to existing "Stats & Leaderboard" link
- Place before ThemeToggle:
  ```tsx
  <Link href="/rankings" className="text-base font-medium tracking-tight hover:opacity-80 transition-opacity">
    Rankings
  </Link>
  ```
- Style to match existing header link

**UsersPage.tsx:**
- Add an "Explore Rankings" button below the date range picker section
- Button links to /rankings
- Style as secondary button matching existing quick range buttons:
  ```tsx
  <Link
    href="/rankings"
    className="px-4 py-2 rounded-md text-sm font-semibold transition-colors mt-4 inline-block"
    style={{
      backgroundColor: 'hsl(var(--primary))',
      color: 'hsl(var(--primary-foreground))',
    }}
  >
    Explore Quarterly Rankings
  </Link>
  ```
- Place after the DateRangePicker, centered
  </action>
  <verify>
1. Build succeeds: `cd /home/tdolfen/Projects/github.com/BeerBILabs/frontend/project && npm run build`
2. Dev server: Header shows "Rankings" link
3. Click Rankings link -> goes to /rankings -> redirects to current quarter
4. Quarterly page shows two-column leaderboard with rank indicators
5. All Time page shows two-column leaderboard without rank indicators
6. Main page has "Explore Quarterly Rankings" button
  </verify>
  <done>All rankings pages show actual leaderboard data. Header and main page have entry points to rankings feature.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete quarterly rankings feature with navigation, leaderboards, and rank change indicators</what-built>
  <how-to-verify>
1. Start dev server if not running: `cd /home/tdolfen/Projects/github.com/BeerBILabs/frontend/project && npm run dev`
2. Visit http://localhost:3000

**Entry Points:**
3. Verify header shows "Rankings" link next to "Stats & Leaderboard"
4. Click header "Rankings" link -> should navigate to /rankings/YYYY/qN (current quarter)
5. Go back to main page, verify "Explore Quarterly Rankings" button exists
6. Click it -> should navigate to /rankings

**Tab Navigation:**
7. On rankings page, verify tabs visible: "All Time" and quarters (Q1-Q4 based on current date)
8. Click "All Time" tab -> URL changes to /rankings/all, year dropdown becomes disabled
9. Click a quarter tab -> URL changes to /rankings/YYYY/qN, year dropdown enabled

**Year Selection:**
10. Change year in dropdown -> URL updates, page shows data for that year
11. For past years (e.g., 2025), all 4 quarters should be visible in tabs

**Shortcut Buttons:**
12. Verify "Current Quarter" and "Last Quarter" buttons visible above tabs
13. Click "Current Quarter" -> navigates to current quarter, button highlights
14. Click "Last Quarter" -> navigates to previous quarter, button highlights

**Leaderboard Display:**
15. Verify two-column layout: "Givers" on left, "Recipients" on right
16. Verify users show with avatars, names, beer counts
17. Verify rank change indicators: arrows (up/down) or "NEW" badges
18. Check that double arrows (big jump) vs single arrows (small change) appear correctly

**Edge Cases:**
19. If viewing current quarter, rank changes compare to previous quarter
20. Change to all-time view -> no rank change indicators shown

**Theme Consistency:**
21. Toggle theme (light/dark) -> rankings page colors update correctly
22. All components use beer-themed colors (golden amber primary)

Report any issues found or type "approved" if everything works correctly.
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
After human approval:
- All QRANK requirements satisfied:
  - QRANK-01: Quarter navigation from main UI (header + button)
  - QRANK-02: Quarterly givers leaderboard
  - QRANK-03: Quarterly recipients leaderboard
  - QRANK-04: Year selector
  - QRANK-05: Shareable URLs
  - QRANK-06: Current Quarter shortcut
  - QRANK-07: Last Quarter shortcut
</verification>

<success_criteria>
- QuarterlyLeaderboard displays givers and recipients with counts
- RankChangeIndicator shows correct arrows/badges based on rank movement
- All rankings pages use QuarterlyLeaderboard component
- Header contains "Rankings" link
- Main page contains "Explore Quarterly Rankings" button
- Human verification confirms full feature works correctly
</success_criteria>

<output>
After completion, create `.planning/phases/03-quarterly-rankings/03-03-SUMMARY.md`
</output>
