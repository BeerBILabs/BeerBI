---
phase: 02-beer-branded-theming
plan: 02
type: execute
wave: 2
depends_on: [02-01]
files_modified:
  - frontend/project/app/actions/theme.ts
  - frontend/project/components/ThemeProvider.tsx
  - frontend/project/app/layout.tsx
autonomous: true

must_haves:
  truths:
    - "Theme preference persists in cookie across browser sessions"
    - "Server renders correct theme class on initial page load"
    - "No flash of wrong theme on hard refresh"
    - "First visit defaults to light mode (not system preference)"
  artifacts:
    - path: "frontend/project/app/actions/theme.ts"
      provides: "Server Action for cookie-based theme persistence"
      exports: ["setThemeCookie"]
    - path: "frontend/project/components/ThemeProvider.tsx"
      provides: "Theme context with cookie sync"
      exports: ["ThemeProvider", "useTheme"]
    - path: "frontend/project/app/layout.tsx"
      provides: "SSR theme class and FOUC prevention"
      contains: "suppressHydrationWarning"
  key_links:
    - from: "ThemeProvider.tsx"
      to: "app/actions/theme.ts"
      via: "server action import"
      pattern: "import.*setThemeCookie.*from.*actions/theme"
    - from: "layout.tsx"
      to: "cookies()"
      via: "Next.js cookies API"
      pattern: "cookies\\(\\)"
---

<objective>
Migrate theme persistence from localStorage to cookies and implement server-side theme reading.

Purpose: Enable the server to read theme preference during SSR, preventing flash of wrong theme (FOUC). Satisfies THEME-03 (cookie persistence), THEME-04 override (light default instead of system preference), and THEME-05 (FOUC prevention).

Output: Server Action for cookie setting, updated ThemeProvider, and layout.tsx with SSR theme support.
</objective>

<execution_context>
@/home/tdolfen/.claude/get-shit-done/workflows/execute-plan.md
@/home/tdolfen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-beer-branded-theming/02-CONTEXT.md
@.planning/phases/02-beer-branded-theming/02-RESEARCH.md

@frontend/project/components/ThemeProvider.tsx
@frontend/project/app/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Server Action for cookie-based theme persistence</name>
  <files>frontend/project/app/actions/theme.ts</files>
  <action>
Create a new file `frontend/project/app/actions/theme.ts` with a Server Action for setting the theme cookie.

```typescript
'use server'

import { cookies } from 'next/headers'

export async function setThemeCookie(theme: 'light' | 'dark') {
  const cookieStore = await cookies()
  cookieStore.set('theme', theme, {
    path: '/',
    maxAge: 60 * 60 * 24 * 365, // 1 year
    sameSite: 'lax',
  })
}
```

This Server Action:
- Uses Next.js `cookies()` API (async in Next.js 15)
- Sets path='/' so cookie is sent on all routes
- Sets maxAge for 1 year persistence
- Uses sameSite='lax' for development compatibility
- Does NOT set httpOnly (we need client-side reading for blocking script)
  </action>
  <verify>
Check file exists: `ls frontend/project/app/actions/theme.ts`
Check content: `grep "setThemeCookie" frontend/project/app/actions/theme.ts`
  </verify>
  <done>
Server Action created that sets theme cookie with correct options.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update ThemeProvider to use cookies instead of localStorage</name>
  <files>frontend/project/components/ThemeProvider.tsx</files>
  <action>
Rewrite ThemeProvider.tsx to use cookies instead of localStorage.

```typescript
"use client"

import { useEffect, useState } from 'react'
import { setThemeCookie } from '@/app/actions/theme'

export function ThemeProvider() {
  const [mounted, setMounted] = useState(false)

  useEffect(() => {
    // Read cookie on mount (cookie already applied server-side, but sync state)
    const theme = document.cookie
      .split('; ')
      .find(row => row.startsWith('theme='))
      ?.split('=')[1] as 'light' | 'dark' | undefined

    // If no cookie exists, default to light and set cookie
    if (!theme) {
      document.documentElement.classList.remove('dark')
      setThemeCookie('light')
    }

    setMounted(true)
  }, [])

  return mounted ? null : null
}

export function useTheme() {
  function setTheme(theme: 'light' | 'dark') {
    const root = document.documentElement
    root.classList.toggle('dark', theme === 'dark')
    // Fire and forget - don't await to avoid blocking UI
    setThemeCookie(theme)
    // Also set client-side cookie for immediate reads (server action may have latency)
    document.cookie = `theme=${theme}; path=/; max-age=31536000; SameSite=Lax`
  }

  function toggleTheme() {
    const isDark = document.documentElement.classList.contains('dark')
    setTheme(isDark ? 'light' : 'dark')
  }

  function getTheme(): 'light' | 'dark' {
    if (typeof document === 'undefined') return 'light'
    return document.documentElement.classList.contains('dark') ? 'dark' : 'light'
  }

  return { setTheme, toggleTheme, getTheme }
}
```

Key changes from original:
- Removed localStorage entirely
- Import and call setThemeCookie Server Action
- Also set client-side cookie for immediate reads (avoids waiting for server action)
- Removed system preference detection (user decision: always default to light)
- Added getTheme() helper for components that need current state
  </action>
  <verify>
Check no localStorage: `grep -c "localStorage" frontend/project/components/ThemeProvider.tsx` should return 0
Check cookie usage: `grep "setThemeCookie" frontend/project/components/ThemeProvider.tsx`
Check import: `grep "import.*setThemeCookie" frontend/project/components/ThemeProvider.tsx`
  </verify>
  <done>
ThemeProvider uses cookies for persistence. No localStorage. Defaults to light mode.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update layout.tsx for SSR theme reading and FOUC prevention</name>
  <files>frontend/project/app/layout.tsx</files>
  <action>
Update layout.tsx to:
1. Read theme from cookie server-side
2. Apply theme class to `<html>` during SSR
3. Add suppressHydrationWarning to prevent React warnings
4. Add blocking script for FOUC prevention (belt and suspenders with SSR)

```typescript
import './globals.css'
import type { Metadata } from 'next'
import type { ReactNode } from 'react'
import { Inter } from 'next/font/google'
import { cookies } from 'next/headers'
import { ThemeProvider } from '../components/ThemeProvider'
import ThemeToggle from '../components/ThemeToggle'
import Logo from '../components/Logo'
import Link from 'next/link'

const inter = Inter({ subsets: ['latin'], weight: ['400', '600', '700'] })

export const metadata: Metadata = {
  title: 'BeerBot Frontend',
  description: 'List givers and recipients and stats',
  icons: { icon: '/favicon.svg' },
}

function ThemeScript() {
  // Blocking script that runs before React hydration to prevent FOUC
  return (
    <script
      dangerouslySetInnerHTML={{
        __html: `
          (function() {
            try {
              var theme = document.cookie
                .split('; ')
                .find(function(row) { return row.startsWith('theme='); });
              if (theme) {
                theme = theme.split('=')[1];
                if (theme === 'dark') {
                  document.documentElement.classList.add('dark');
                } else {
                  document.documentElement.classList.remove('dark');
                }
              }
            } catch (e) {}
          })();
        `,
      }}
    />
  )
}

export default async function RootLayout({ children }: { children: ReactNode }) {
  const cookieStore = await cookies()
  const theme = cookieStore.get('theme')?.value || 'light'

  return (
    <html lang="en" className={theme === 'dark' ? 'dark' : ''} suppressHydrationWarning>
      <head>
        <ThemeScript />
      </head>
      <body className={`${inter.className} min-h-screen surface flex flex-col`}>
        <ThemeProvider />
        <header className="w-full surface-inverse border-b bordered shadow-sm sticky top-0 z-30">
          <div className="max-w-5xl mx-auto flex items-center gap-4 px-8 py-4">
            <Logo className="h-10 w-auto" />
            <span className="ml-auto text-base font-medium tracking-tight"><Link href="/">Stats &amp; Leaderboard</Link></span>
            <ThemeToggle />
          </div>
        </header>
        <main className="flex-1 flex flex-col items-center justify-center px-2">
          <div className="w-full max-w-3xl card rounded-2xl shadow-lg p-8 mt-10 mb-10 border bordered">
            {children}
          </div>
        </main>
        <footer className="w-full text-center text-xs py-6 border-t bordered surface-inverse">
          <span>Made with <span className="text-[#d4a84b] font-bold">&#9829;</span> by BeerBot Team</span>
        </footer>
      </body>
    </html>
  )
}
```

Key changes:
- Made RootLayout async to use await cookies()
- Import `cookies` from 'next/headers'
- Read theme cookie server-side, default to 'light'
- Apply theme class to `<html>` element in SSR
- Add suppressHydrationWarning to `<html>` (required for theme systems)
- Add ThemeScript component in `<head>` for FOUC prevention
- Updated footer heart color from #00c896 to #d4a84b (amber/gold to match theme)
  </action>
  <verify>
Check async: `grep "async function RootLayout" frontend/project/app/layout.tsx`
Check cookies import: `grep "import.*cookies.*from.*next/headers" frontend/project/app/layout.tsx`
Check suppressHydrationWarning: `grep "suppressHydrationWarning" frontend/project/app/layout.tsx`
Check ThemeScript: `grep "ThemeScript" frontend/project/app/layout.tsx`
  </verify>
  <done>
layout.tsx reads theme from cookie server-side, applies class during SSR, includes FOUC prevention script.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Build check: `cd frontend/project && npm run build` passes
2. Type check: `cd frontend/project && npx tsc --noEmit` passes (TypeScript)
3. No localStorage: `grep -r "localStorage" frontend/project/components/ThemeProvider.tsx` returns nothing
4. Server action exists: `cat frontend/project/app/actions/theme.ts`
5. Cookie reading works: layout.tsx imports and uses cookies()

Functional verification will happen in Plan 03 with human visual check.
</verification>

<success_criteria>
- Server Action file created at app/actions/theme.ts
- ThemeProvider uses cookies (not localStorage)
- layout.tsx is async and reads cookies server-side
- layout.tsx has suppressHydrationWarning on html element
- Blocking script in head for FOUC prevention
- First visit defaults to light mode (no system preference check)
- Build and type check pass
</success_criteria>

<output>
After completion, create `.planning/phases/02-beer-branded-theming/02-02-SUMMARY.md`
</output>
